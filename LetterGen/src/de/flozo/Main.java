package de.flozo;

import de.flozo.data.*;
import de.flozo.latex.core.*;
import de.flozo.latex.tikz.Layer;
import de.flozo.latex.tikz.LayerEnvironment;
import de.flozo.latex.tikz.Rectangle;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

public class Main {

    // constants
    public static final String VERSION_NUMBER = "0.1";
    public static final String VERSION_DATE = "2022-05-17";
    public static final String REPO_URL = "https://github.com/flozo/LetterGen";
    public static final String VERSION_INFO_LATEX_HEADER = String.format("%% =====  LaTeX code generated by LetterGen v%1$s (%2$s)\n%% =====  LetterGen by flozo (%3$s)",
            VERSION_NUMBER, VERSION_DATE, REPO_URL);
    public static final String VERSION_INFO_PDF_META_DATA = String.format("LetterGen v%1$s (%2$s); visit %3$s",
            VERSION_NUMBER, VERSION_DATE, REPO_URL);

    public static final String MASTER_CONFIG_FILE_NAME = "master.config";


    public static void main(String[] args) {

        // read settings from config files
//        System.out.println("**************");
//        Properties geometryProperties = settings.getConfigGroupProperties(ConfigGroup.LETTER_GEOMETRY);
//        System.out.println("**************");
//        System.out.println("From file: " + geometryProperties.get(LetterGeometryProperty.BACKADDRESS_Y.getPropertyName()));


        Settings settings = new Settings(MASTER_CONFIG_FILE_NAME);

        PropertyMap letterGeometryMap = new PropertyMap(ConfigGroup.LETTER_GEOMETRY);
        letterGeometryMap.updateDefaults(settings);
        LetterGeometry geometry = new LetterGeometry(letterGeometryMap);

        PropertyMap senderMap = new PropertyMap(ConfigGroup.SENDER_DATA);
        senderMap.updateDefaults(settings);
        Address senderData = new Address(senderMap);

        PropertyMap receiverMap = new PropertyMap(ConfigGroup.RECEIVER_DATA);
        receiverMap.updateDefaults(settings);
        Address receiverData = new Address(receiverMap);


        System.out.println("**************");
        System.out.println("Backaddress font soze: " + geometry.getBackaddressFontSize());
        System.out.println("Backaddress x: " + geometry.getBackaddressX()*2);
        System.out.println(senderData.getFirstName());
        System.out.println(senderData.getLastName());
        System.out.println(senderData.getStreet());
        System.out.println(senderData.getHouseNumber());
        System.out.println(senderData.getPostalCode());
        System.out.println(senderData.getCity());
        System.out.println("--------------");

        System.out.println(receiverData.getFirstName());
        System.out.println(receiverData.getLastName());
        System.out.println(receiverData.getStreet());
        System.out.println(receiverData.getHouseNumber());
        System.out.println(receiverData.getPostalCode());
        System.out.println(receiverData.getCity());


        System.out.println("==========0");
        System.out.println(LetterGeometryProperty.ADDRESS_X.getEntry());
        System.out.println(LetterGeometryProperty.BACKADDRESS_SEPCHAR.getEntry());

        System.out.println("???????????");


//        System.out.println(typedSettings.getAllTyped().get(LetterGeometryProperty.BACKGROUND_COLOR.getString()).getString());
//        LetterGeometry geometry = new LetterGeometry(typedSettings);
//
//        System.out.println(geometry.getAddressWidth());

//        LetterGeometry geometry = new LetterGeometry(geometryProperties);
//        Address sender = new Address(senderData);
//        Address receiver = new Address(receiverData);
//        Map<String, GenericTypeValue> geometry = settings.getTypedProperties(ConfigGroup.LETTER_GEOMETRY);
//        geometry.get(LetterGeometryProperty.PERFORATION_MARK_X).getNumber();


//        System.out.println(geometry.getBackaddressFontSize());


//        String pdfauthor = senderData.getProperty("person.name.first", "My") + " " + senderData.getProperty("person.name.family", "Name");


        Documentclass documentclass = new Documentclass(PackageName.STANDALONE, "12pt", "tikz", "multi", "crop");

        PackageList packageList = new PackageList(documentclass);
        packageList.add(PackageName.INPUTENC, "utf8")
                .add(PackageName.FONTENC, "T1")
                .add(PackageName.BABEL, "german")
                .add(PackageName.HYPERXMP)
                .add(PackageName.FIRASANS, "sfdefault", "scaled=1.0098")
                .add(PackageName.NEWTXSF)
                .add(PackageName.FONTAWESOME5)
                .add(PackageName.CSQUOTES, "autostyle=true")
                .add(PackageName.ENUMITEM)
                .add(PackageName.MICROTYPE, "activate={true, nocompatibility}", "final", "tracking=true", "kerning=true", "spacing=true", "factor=1100", "stretch=8", "shrink=8")
                .add(PackageName.TIKZ)
                .add(PackageName.HYPERREF, "unicode");

        Command2 usetikzlibrary = new Command2.Command2Builder(CommandName.USETIKZLIBRARY.getString())
                .body(
                        "positioning",
                        "math",
                        "colorbrewer",
                        "backgrounds",
                        "matrix")
                .bodyTerminator(StatementTerminator.COMMA)
                .build();
        Command2 standaloneenv = new Command2.Command2Builder(CommandName.STANDALONEENV.getString())
                .body("tikzpicture")
                .build();

        Command2 hypersetup = new Command2.Command2Builder(CommandName.HYPERSETUP.getString())
                .body(
                        "colorlinks=true",
//                        String.format("urlcolor=%s", geometryProperties.getProperty("url_hyperlink.color", "Blues-K")),
                        "pdftitle={Letter}",
//                        String.format("pdfauthor={%s}", pdfauthor),
                        String.format("pdfdate={%s}", LocalDate.now()),
                        String.format("pdfproducer={%s}", VERSION_INFO_PDF_META_DATA)
//                        String.format("pdfcontactemail={%s}", senderData.getProperty("communication.email", "me@mail.com"))
                )
                .bodyTerminator(StatementTerminator.COMMA)
                .build();

        List<String> packageSettings = new ArrayList<>();
        packageSettings.add(usetikzlibrary.getInline());
        packageSettings.add(standaloneenv.getInline());
        packageSettings.addAll(hypersetup.getBlock());
        List<String> preamble = new ArrayList<>(packageList.getBlock());
        preamble.addAll(packageSettings);

        Layer pgflayers = new Layer.LayerBuilder("background", "forebackground", "main", "foreground")
                .build();

        Rectangle backgroundRectangle = new Rectangle.RectangleBuilder(0, 0, Defaults.A4_WIDTH, Defaults.A4_HEIGHT)
                .fillColor(new Color(StandardColorName.NONE))
                .drawColor(new Color(StandardColorName.NONE))
                .build();

        LayerEnvironment onBackgroundLayer = new LayerEnvironment("background", backgroundRectangle.getStatement());


//        PerforationMark perforationMark = new PerforationMark(geometryProperties);

//        LayerEnvironment onForegroundLayer = new LayerEnvironment("foreground", perforationMark.getStatement());
//
        ExpressionList2 tikzpictureBody = new ExpressionList2.ExpressionList2Builder()
                .append(onBackgroundLayer.getBlock())
//                .append(onForegroundLayer.getBlock())
                .build();

        Environment3 tikzpicture = new Environment3.Environment3Builder(EnvironmentName.TIKZPICTURE)
                .optionalArguments("inner xsep=0pt", "inner ysep=0pt", "trim left=0pt", "trim right=" + Defaults.A4_WIDTH + "cm")
                .body(tikzpictureBody.getBlock())
                .build();


        ExpressionList2 documentBody = new ExpressionList2.ExpressionList2Builder()
                .append(pgflayers.getBlock())
                .append(tikzpicture.getBlock())
                .append()
                .build();

        Environment3 document = new Environment3.Environment3Builder(EnvironmentName.DOCUMENT)
                .body(documentBody.getBlock())
                .build();


        // Assemble final code
        List<String> finalCode = new ArrayList<>(preamble);
        finalCode.addAll(document.getBlock());

        String fileName = "test_output.tex";
        String directory = "/tmp";

        OutputFile outputFile = new OutputFile(directory, fileName, finalCode);
        if (outputFile.create(true, true)) {
            System.out.println("[output] Done!");
        } else {
            System.out.println("[output] Something went wrong!");
        }
    }
}
